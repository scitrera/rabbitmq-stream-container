name: Rebuild derived RabbitMQ when upstream changes

on:
  schedule:
    - cron: "0 * * * *" # hourly
  workflow_dispatch:

jobs:
  rebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull upstream and compute digest + labels + version
        id: upstream
        shell: bash
        run: |
          set -euo pipefail

          UPSTREAM_TAG="rabbitmq:4-management"
          docker pull "${UPSTREAM_TAG}"

          # RepoDigest looks like: rabbitmq@sha256:...
          REPO_DIGEST="$(docker inspect --format='{{index .RepoDigests 0}}' "${UPSTREAM_TAG}")"
          DIGEST="${REPO_DIGEST#*@}"   # sha256:...
          echo "repo_digest=${REPO_DIGEST}" >> "$GITHUB_OUTPUT"
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

          # OCI version label usually matches RabbitMQ version (e.g. 4.2.2)
          VERSION="$(docker inspect --format='{{ index .Config.Labels "org.opencontainers.image.version" }}' "${UPSTREAM_TAG}" || true)"
          if [[ -z "${VERSION}" || "${VERSION}" == "<no value>" ]]; then
            # fallback: ask rabbitmq itself (slower, but robust)
            VERSION="$(docker run --rm "${UPSTREAM_TAG}" rabbitmq-diagnostics -q version | tr -d '\r')"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

          # Export upstream labels as repeated --label args
          python - <<'PY' > /tmp/label_args.txt
          import json, subprocess, shlex
          
          img = "rabbitmq:4-management"
          insp = subprocess.check_output(["docker","inspect",img], text=True)
          data = json.loads(insp)[0]
          
          labels = data.get("Config", {}).get("Labels", {}) or {}
          
          args = []
          for k, v in labels.items():
              args.append("--label")
              args.append(f"{k}={v}")
          
          # Add your own provenance label
          args.append("--label")
          args.append("io.botwinick.derived=true")
          
          print(" ".join(shlex.quote(a) for a in args))
          PY


          echo "label_args_file=/tmp/label_args.txt" >> "$GITHUB_OUTPUT"
          echo "Upstream repo digest: ${REPO_DIGEST}"
          echo "Upstream version: ${VERSION}"

      - name: Read last digest
        id: last
        shell: bash
        run: |
          if [[ -f upstream-digest.txt ]]; then
            echo "digest=$(cat upstream-digest.txt)" >> "$GITHUB_OUTPUT"
          else
            echo "digest=" >> "$GITHUB_OUTPUT"
          fi

      - name: Decide whether rebuild is needed
        id: decide
        shell: bash
        run: |
          if [[ "${{ steps.upstream.outputs.digest }}" == "${{ steps.last.outputs.digest }}" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No upstream change."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Upstream changed!"
          fi

      - name: Build & push derived image (mirror tags)
        if: steps.decide.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail

          OWNER="${{ github.repository_owner }}"
          IMAGE="ghcr.io/${OWNER}/rabbitmq-streams"

          VERSION="${{ steps.upstream.outputs.version }}"
          MAJOR="${VERSION%%.*}"                 # 4
          MINOR="${VERSION%.*}"                  # 4.2

          # Our tag set:
          TAGS=(
            "${MAJOR}-management"
            "${MINOR}-management"
            "${VERSION}-management"
          )

          # Base pinned to exact upstream digest to guarantee reproducibility
          BASE_IMAGE="rabbitmq@${{ steps.upstream.outputs.digest }}"

          # Build tag args
          TAG_ARGS=()
          for t in "${TAGS[@]}"; do
            TAG_ARGS+=( -t "${IMAGE}:${t}" )
          done

          # Labels: copy upstream labels + add ours
          LABEL_ARGS=( $(cat "${{ steps.upstream.outputs.label_args_file }}") )

          docker buildx build \
            --push \
            --platform linux/amd64,linux/arm64 \
            --build-arg BASE_IMAGE="${BASE_IMAGE}" \
            "${LABEL_ARGS[@]}" \
            "${TAG_ARGS[@]}" \
            .

      - name: Store new digest
        if: steps.decide.outputs.changed == 'true'
        shell: bash
        run: |
          echo "${{ steps.upstream.outputs.digest }}" > upstream-digest.txt
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add upstream-digest.txt
          git commit -m "Track upstream rabbitmq:4-management digest ${{ steps.upstream.outputs.digest }}" || exit 0
          git push

name: Rebuild derived RabbitMQ when upstream changes

on:
  schedule:
    - cron: "0 * * * *" # hourly
  workflow_dispatch:

jobs:
  rebuild:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull upstream and compute digest + labels + version
        id: upstream
        shell: bash
        run: |
          set -euo pipefail

          UPSTREAM_TAG="rabbitmq:4-management"

          # Pull upstream (optional: force amd64 for deterministic RepoDigests)
          docker pull "${UPSTREAM_TAG}"

          # RepoDigest looks like: rabbitmq@sha256:...
          REPO_DIGEST="$(docker inspect --format='{{index .RepoDigests 0}}' "${UPSTREAM_TAG}")"
          DIGEST="${REPO_DIGEST#*@}"   # sha256:...
          echo "repo_digest=${REPO_DIGEST}" >> "$GITHUB_OUTPUT"
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

          # Prefer RABBITMQ_VERSION from image env; fallback to rabbitmq-diagnostics
          VERSION="$(
            docker inspect --format '{{range .Config.Env}}{{println .}}{{end}}' "${UPSTREAM_TAG}" \
              | sed -n 's/^RABBITMQ_VERSION=//p' \
              | head -n1
          )"
          if [[ -z "${VERSION}" || "${VERSION}" == "<no value>" ]]; then
            VERSION="$(docker run --rm "${UPSTREAM_TAG}" rabbitmq-diagnostics -q version | tr -d '\r')"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "RabbitMQ version: ${VERSION}"

          # Export upstream labels as repeated --label args, one arg per line so bash can read safely
          python - <<'PY' > /tmp/label_args.txt
          import json, subprocess

          img = "rabbitmq:4-management"
          data = json.loads(subprocess.check_output(["docker", "inspect", img], text=True))[0]
          labels = data.get("Config", {}).get("Labels", {}) or {}

          for k, v in labels.items():
              print("--label")
              print(f"{k}={v}")

          # Add your own base provenance label
          print("--label")
          print("io.scitrera.derived=true")
          PY

          echo "label_args_file=/tmp/label_args.txt" >> "$GITHUB_OUTPUT"
          echo "Upstream repo digest: ${REPO_DIGEST}"
          echo "Upstream version: ${VERSION}"

      - name: Read last digest
        id: last
        shell: bash
        run: |
          if [[ -f upstream-digest.txt ]]; then
            echo "digest=$(cat upstream-digest.txt)" >> "$GITHUB_OUTPUT"
          else
            echo "digest=" >> "$GITHUB_OUTPUT"
          fi

      - name: Decide whether rebuild is needed
        id: decide
        shell: bash
        run: |
          if [[ "${{ steps.upstream.outputs.digest }}" == "${{ steps.last.outputs.digest }}" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No upstream change."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Upstream changed!"
          fi

      - name: Build & push derived image (mirror tags)
        if: steps.decide.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail

          UPSTREAM_TAG="rabbitmq:4-management"
          REPO_DIGEST="${{ steps.upstream.outputs.repo_digest }}"

          OWNER="${{ github.repository_owner }}"
          IMAGE="ghcr.io/${OWNER}/rabbitmq-stream"

          VERSION="${{ steps.upstream.outputs.version }}"
          MAJOR="${VERSION%%.*}"                 # 4
          MINOR="${VERSION%.*}"                  # 4.2

          TAGS=(
            "${MAJOR}-management"
            "${MINOR}-management"
            "${VERSION}-management"
          )

          # Base pinned to exact upstream digest to guarantee reproducibility
          BASE_IMAGE="docker.io/library/rabbitmq@${{ steps.upstream.outputs.digest }}"

          TAG_ARGS=()
          for t in "${TAGS[@]}"; do
            TAG_ARGS+=( -t "${IMAGE}:${t}" )
          done

          # Labels: copy upstream labels + add ours
          mapfile -t LABEL_ARGS < "${{ steps.upstream.outputs.label_args_file }}"
          LABEL_ARGS+=( --label "io.scitrera.upstream.tag=${UPSTREAM_TAG}" )
          LABEL_ARGS+=( --label "io.scitrera.rabbitmq.version=${VERSION}" )
          LABEL_ARGS+=( --label "io.scitrera.upstream.digest=${REPO_DIGEST}" )

          docker buildx build \
            --push \
            --platform linux/amd64,linux/arm64 \
            --build-arg BASE_IMAGE="${BASE_IMAGE}" \
            "${LABEL_ARGS[@]}" \
            "${TAG_ARGS[@]}" \
            .

      - name: Store new digest
        if: steps.decide.outputs.changed == 'true'
        shell: bash
        run: |
          echo "${{ steps.upstream.outputs.digest }}" > upstream-digest.txt
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add upstream-digest.txt
          git commit -m "Track upstream rabbitmq:4-management digest ${{ steps.upstream.outputs.digest }}" || exit 0
          git push
